---
- name: Use root as Sandbox user for apt
  lineinfile:
    dest: /etc/apt/apt.conf.d/70debconf
    line: 'APT::Sandbox::User "root";'
    state: present

- name: Ensure packages are installed
  apt:
    name: "{{ item }}"
  with_items:
      - apt-utils
      - git
      - rsync
      - libpq-dev
      - libcurl4-openssl-dev
      - cron

- name: Install additional packages 
  apt:
    name: "{{ item.key }}={{ item.value.version }}"
  when: additional_packages
  with_dict: "{{ additional_packages }}"

- name: Install bundler 
  gem:
    name: bundler
    state: latest
    user_install: false

- name: Creating project_root directory
  file:
    path: /var/www
    state: directory
    mode: 0755

- name: Copy all node data
  command: rsync -auvh --chown=root:root /tmp/railsapp/ /var/www/
  
- name: Start cron in background
  command: cron -f&

- name: Install all gems
  bundler:
    state: present
    gemfile: "/var/www/Gemfile"
    user_install: false
