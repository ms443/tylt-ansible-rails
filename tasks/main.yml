---
- name: ensure packages are installed
  apt:
    name: "{{ item }}"
  with_items:
      - git
      - libpq-dev
      - libcurl4-openssl-dev

- name: Install bundler 
  gem:
    name: bundler
    state: latest
    user_install: false

- name: Creating project_root directory
  file:
    path: "{{ item }}"
    state: directory
    mode: 0755
  with_items:
    - "{{ working_dir }}/current/tmp/pids"

- name: Copy all node data
  command: "cp -fr /tmp/railsapp/. {{ working_dir }}/current"

- name: Install all gems
  bundler:
    state: present
    gemfile: "{{ working_dir }}/current/Gemfile"
    user_install: false

- name: Precompile asse
  command: chdir="{{ working_dir }}/current" bundle exec rake assets:precompile
  environment:
    RAILS_ENV: kube
