---
- name: Ensure packages are installed
  apk:
    name: "{{ item }}"
    update_cache: yes
  with_items:
      - git
      - curl
      - rsync
      - tzdata
      - libcurl
      - build-base
      - alpine-sdk
      - jemalloc-dev
      - postgresql-dev
      - linux-headers
      - nodejs
      
- name: Install additional packages 
  apk:
    name: "{{ item }}"
    update_cache: yes
  when: additional_packages
  with_items: "{{ additional_packages }}"
  
- name: Install ruby version
  shell: source ~/.rvm/scripts/rvm && rvm install "{{ ruby_version }}" && rvm install "{{ ruby_version }}"
  args:
    executable: /bin/bash

- name: Creating project_root directory
  file:
    path: /var/www
    state: directory
    mode: 0755

- name: Clean migrations and .tags
  file:
    state: absent
    path:
  with_items:
    -  /var/cache/apk/
    - /var/www/db/migrate/

- name: Copy all node data
  command: rsync -auvh --delete --chown=root:root /tmp/railsapp/ /var/www/ --exclude vendor/bundle

- name: Install all gems
  bundler:
    state: present
    gemfile: "/var/www/Gemfile"
    deployment_mode: yes
    clean: yes
    extra_args: "--without development test"
    executable: "/usr/local/bin/bundle"

- name: Remove unnecessary packages
  apk:
    name: "{{ item }}"
    state: absent
  with_items:
      - git
      - rsync
      - build-base
      - alpine-sdk
      - jemalloc-dev
      - linux-headers
