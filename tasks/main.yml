---
- name: Use root as Sandbox user for apt
  lineinfile:
    dest: /etc/apt/apt.conf.d/70debconf
    line: 'APT::Sandbox::User "root";'
    state: present

- name: Ensure the system can use the HTTPS transport for APT
  stat:
    path: /usr/lib/apt/methods/https
  register: apt_https_transport

- name: Install HTTPS transport for APT
  apt:
    pkg: apt-transport-https
    state: installed
  when: not apt_https_transport.stat.exists
  
#- name: Add Launchpad PPA for Brightbox key
#  apt_key:
#    id: 'C3173AA6'
#    keyserver: 'keyserver.ubuntu.com'
#    state: present

#- name: Add Launchpad PPA for Brightbox deb repository
#  apt_repository:
#    repo: 'deb http://ppa.launchpad.net/brightbox/ruby-ng/ubuntu xenial main'
#    state: present


- name: RVM Install
  include_role:
    name: rvm.ruby
  vars:
    rvm1_rubies: "ruby-{{ lookup('file', '/tmp/railsapp/.ruby-version') }}"
    rvm1_install_path: '/usr/local/rvm'
    rvm1_user: 'root'
  become_user: yes
    
- name: Ensure packages are installed
  apt:
    name: "{{ item }}"
  with_items:
      - apt-utils
      - git
      - rsync
      - libpq-dev
      - libcurl4-openssl-dev
      - libuv1

- name: Install additional packages 
  apt:
    name: "{{ item.key }}={{ item.value.version }}"
    force: yes
  when: additional_packages
  with_dict: "{{ additional_packages }}"

- name: Install bundler and whenever 
  gem:
    name: "{{ item }}"
    state: latest
    user_install: false
  with_items:
      - bundler
      - whenever

- name: Creating project_root directory
  file:
    path: /var/www
    state: directory
    mode: 0755

- name: Clean migrate path
  file:
    state: absent
    path: "/var/www/db/migrate/"

- name: Copy all node data
  command: rsync -auvh --delete --chown=root:root /tmp/railsapp/ /var/www/ --exclude vendor/bundle

- name: Install all gems
  bundler:
    state: present
    gemfile: "/var/www/Gemfile"
    deployment_mode: yes
    clean: yes
    extra_args: "--without development test"
